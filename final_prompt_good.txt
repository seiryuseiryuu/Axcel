
> export async function generateFinalThumbnails(
      modelImage: ModelImageInfo | null,
      text: string,
      videoTitle: string,
      count: number = 3,
      patternData?: PatternCategory,
      referenceUrls?: string[]
  ): Promise<{ data?: string[]; error?: string }> {
      await requireRole("student");
  
      if (!text) {
          return { error: "繧ｵ繝繝阪う繝ｫ譁・ｨ・医ユ繝ｭ繝・・・峨ｒ蜈･蜉帙＠縺ｦ縺上□縺輔＞縲・ };
      }
  
      try {
          const images: string[] = [];
  
          // Fetch reference images if provided
          let referenceImages: { mimeType: string; data: string }[] = [];
          if (referenceUrls && referenceUrls.length > 0) {
              const fetchPromises = referenceUrls.slice(0, 2).map(async (url) => {
                  try {
                      const controller = new AbortController();
                      const timeoutId = setTimeout(() => controller.abort(), 5000);
                      const res = await fetch(url, { signal: controller.signal });
                      clearTimeout(timeoutId);
                      if (!res.ok) return null;
                      const buffer = await res.arrayBuffer();
                      const base64 = Buffer.from(buffer).toString('base64');
                      const mimeType = res.headers.get('content-type') || 'image/jpeg';
                      return { mimeType, data: base64 };
                  } catch { return null; }
              });
              referenceImages = (await Promise.all(fetchPromises)).filter(Boolean) as any[];
          }
  
          // Get text styling from pattern
          const textStyle = patternData?.characteristics?.textStyle || "bold white with black outlin
e";
          const colorScheme = patternData?.characteristics?.colorScheme || "high contrast";
  
          for (let i = 0; i < count; i++) {
              // Enhanced prompt that emphasizes using the model image as base
              const variationPrompt = `[TASK]: Create a final YouTube thumbnail by combining the mod
el image with text overlay.
  
  [MANDATORY - EXACT TEXT]
  The ONLY text on this thumbnail must be: "${text}"
  - DO NOT add any other text, labels, watermarks, or typography
  - Text must be large, bold, and highly readable
  - Font style: ${textStyle}
  - Text position: prominent center or upper area, maximum visibility
  
  [STYLE REFERENCE]
  - Pattern name: ${modelImage?.patternName || 'professional thumbnail'}
  - Use the model image as the primary visual base
  - Maintain the same person, pose, expression, lighting, and composition from the model
  - Color scheme: ${colorScheme}
  
  [SPECIFICATIONS]
  - Resolution: 1280x720 (16:9 aspect ratio)
  - Style: ${patternData?.description || 'eye-catching YouTube thumbnail'}
  ${patternData?.characteristics?.visualTechniques ? `- Visual effects: ${patternData.characteristic
s.visualTechniques}` : ''}
  
  [CRITICAL QUALITY REQUIREMENTS]
  - Create as if this is taken from a professional YouTube channel
  - Photorealistic quality for any people in the image
  - Sharp, high-definition image (8K equivalent quality)
  - Professional color grading and contrast
  - The text "${text}" must look like it was designed by a professional graphic designer
  
  [VARIATION ${i + 1} of ${count}]
  ${i === 0 ? '- Standard composition from model image' : i === 1 ? '- Slightly more dynamic composi
tion, vibrant colors' : '- Alternative angle or emphasis, maintain quality'}
  
  IMPORTANT: The person in the image must look exactly like the model image. The text styling must m
atch the reference thumbnails.`;
  
              let imageUrl: string;
              if (referenceImages.length > 0) {
                  // Use multimodal generation with reference images
                  const { generateImageWithReference } = await import("@/lib/gemini");
                  imageUrl = await generateImageWithReference(variationPrompt, referenceImages);
              } else {
                  imageUrl = await generateThumbnailImage(variationPrompt);


